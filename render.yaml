services:
  # 2. Servicio de Backend PHP-FPM (Servicio Privado)
  - type: web # <--- CAMBIO CLAVE: Usar 'web'
    name: app
    env: docker
    dockerfilePath: docker/php/Dockerfile
    dockerContext: .
    autoDeploy: true
    branch: main
    # NUEVO: Marcarlo como interno para que no tenga URL pública
    internal: true
    # NUEVO: Especificar el puerto que expone (PHP-FPM usa 9000)
    # Aunque el Dockerfile ya lo expone, es buena práctica en el YAML
    ports:
      - 9000
    # En el servicio 'app' del render.yaml
    startCommand: "php /var/www/html/artisan migrate --force && php-fpm -F"

    # Variables de Entorno del Backend de Laravel
    envVars:
      # [SEGURIDAD] Estas credenciales de Railway están visibles. 
      # Considera usar Secret Files o el dashboard de Render para inyectar estos valores.
      - key: DB_HOST
        value: gondola.proxy.rlwy.net
      - key: DB_USERNAME
        value: root 
      # ... (otras variables de DB)
      - key: DB_CONNECTION
        value: mysql
      - key: APP_KEY
        generateValue: true
      - key: APP_ENV
        value: production
      - key: NGINX_HOST
        value: ritmatiza-web.onrender.com

  # 3. Servicio Web Nginx (El Punto de Entrada Público)
  - type: web
    name: ritmatiza-web
    env: docker
    dockerfilePath: docker/nginx/Dockerfile
    dockerContext: .
    autoDeploy: true
    branch: main
    
    # ELIMINADO: buildCommand (la compilación se hace ahora en el Dockerfile)

    envVars:
      - key: APP_URL
        value: https://${ritmatiza-web.host} # Esto inyecta la URL de Render automáticamente
    
    # [OPCIONAL] Health check es correcto, pero debe apuntar a un archivo *existente*
    healthCheckPath: /health.html