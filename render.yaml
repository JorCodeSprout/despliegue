services:
  # 1. Base de Datos MySQL (Servicio Privado)
  # Necesitas crear esta base de datos manualmente en el dashboard de Render.
  - type: pserv # Tipo genérico para la base de datos
    name: ritmatiza-mysql
    plan: starter
    env: mysql
    port: 3306 # Puerto interno estándar de MySQL para el servicio privado
    # Nota: Los campos databaseName, region, e ipAllowList NO son válidos aquí.

  # 2. Servicio de Backend PHP-FPM (Servicio Interno)
  - type: web
    name: app
    env: docker
    dockerfilePath: docker/php/Dockerfile
    dockerContext: .
    autoDeploy: true
    branch: main
    # Se elimina 'port: 9000'. El puerto es gestionado internamente por el startCommand.
    startCommand: "sh -c 'chmod -R 777 /var/www/html/storage /var/www/html/bootstrap/cache && exec docker-php-entrypoint php-fpm'"

    # Variables de Entorno del Backend de Laravel
    envVars:
      - key: DB_HOST
        value: ${ritmatiza-mysql.host}
      - key: DB_USERNAME
        # IMPORTANTE: Reemplazar con el usuario estático de la BD creada manualmente en Render
        value: TU_USUARIO_ESTATICO_DB
      - key: DB_PASSWORD
        # IMPORTANTE: Reemplazar con la contraseña estática de la BD creada manualmente en Render
        value: TU_PASSWORD_ESTATICO_DB
      - key: DB_DATABASE
        # Asegúrate de que este nombre coincida con el nombre de la BD que creaste manualmente
        value: ritmatiza_db
      - key: APP_KEY
        generateValue: true
      - key: APP_ENV
        value: production
      - key: NGINX_HOST
        value: ritmatiza-web.onrender.com

  # 3. Servicio Web Nginx (El Punto de Entrada Público)
  - type: web
    name: ritmatiza-web
    env: docker
    dockerfilePath: docker/nginx/Dockerfile
    dockerContext: .
    autoDeploy: true
    branch: main
    # Se elimina 'port: 80'. Render usa el puerto 80 por defecto para servicios web.

    # CRÍTICO: Comando que compila React y mueve los archivos
    buildCommand: |
      cd frontend && npm install
      npm run build
      mv dist/* ../backend/public/
      cd ..

    envVars:
      - key: APP_URL
        value: https://${ritmatiza-web.host}

    healthCheckPath: /