upstream laravel_backend {
    # Definimos la variable para el host interno
    set $backend_host "laravel-api"; 

    # La directiva server usa la variable (resolución dinámica) y el puerto
    server $backend_host:9000;
}

server {
    listen 80;
    server_name _;

    # El root ahora apunta al directorio del frontend compilado
    root /usr/share/nginx/html; 

    # Prioridad: index.html primero
    index index.html index.php; 
    charset utf-8;

    location ~ ^/(api/.*|index.php)$ { 
        # Usamos el upstream dinámico
        fastcgi_pass laravel_backend;
        
        # SCRIPT_FILENAME apunta a la nueva ubicación del index.php
        fastcgi_param SCRIPT_FILENAME /var/www/html/laravel_entrypoint/index.php; 
        
        include fastcgi_params;
        fastcgi_param PATH_INFO $request_uri; 
        fastcgi_param SCRIPT_NAME /index.php;
    }

    # Bloque para el Frontend (React/SPA)
    location / {
        # Si no es un archivo estático ($uri), usa el fallback a index.html (SPA routing)
        try_files $uri $uri/ /index.html; 
    }

    # Manejo del health check (debe existir el archivo en /usr/share/nginx/html/health.html)
    location = /health.html {
        return 200 'OK';
        access_log off;
        log_not_found off;
    }

    error_log /var/log/nginx/error.log;
    access_log /var/log/nginx/access.log;
}