server {
    listen 80;
    server_name _;

    # El root ahora apunta al directorio del frontend compilado
    root /usr/share/nginx/html; 

    # Prioridad: index.html primero
    index index.html index.php; 
    charset utf-8;

    # Bloque para la API (Laravel)
    # Solo las rutas que empiecen con /api/ o sean /index.php irán al backend
    location ~ ^/(api/.*|index.php)$ { 
         # CORRECCIÓN CLAVE: Usar el nombre de host interno real de Render
         fastcgi_pass laravel-api:9000; 
         
         # SCRIPT_FILENAME apunta a la nueva ubicación del index.php
         fastcgi_param SCRIPT_FILENAME /var/www/html/laravel_entrypoint/index.php; 
         
         include fastcgi_params;
         # Nota: $document_root no se usa aquí para evitar conflictos de rutas
         fastcgi_param PATH_INFO $request_uri; 
         fastcgi_param SCRIPT_NAME /index.php;
    }

    # Bloque para el Frontend (React/SPA)
    location / {
        # Si no es un archivo estático ($uri), usa el fallback a index.html (SPA routing)
        try_files $uri $uri/ /index.html; 
    }

    # Manejo del health check (debe existir el archivo en /usr/share/nginx/html/health.html)
    location = /health.html {
        return 200 'OK';
        access_log off;
        log_not_found off;
    }

    error_log /var/log/nginx/error.log;
    access_log /var/log/nginx/access.log;
}