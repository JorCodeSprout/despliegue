server {
    listen 80;
    server_name _;

    # CRÍTICO: Definimos el resolver dentro del contexto server
    # 127.0.0.11 es el DNS interno de Docker (es el más fiable en Alpine/Render)
    resolver 127.0.0.11 valid=5s; 
    
    # 1. Definimos la variable para el Host Interno de Render
    # 'laravel-api' es el nombre del servicio interno.
    set $internal_backend_host "laravel-api";

    root /usr/share/nginx/html; 
    index index.html index.php; 
    charset utf-8;

    # Bloque para la API (Laravel)
    location ~ ^/(api/.*|index.php)$ { 
         # 2. Usamos fastcgi_pass DIRECTAMENTE con la variable
         # Nginx usará el 'resolver' para obtener la IP de $internal_backend_host en runtime
         fastcgi_pass $internal_backend_host:9000;
         
         fastcgi_param SCRIPT_FILENAME /var/www/html/laravel_entrypoint/index.php; 
         
         include fastcgi_params;
         fastcgi_param PATH_INFO $request_uri; 
         fastcgi_param SCRIPT_NAME /index.php;
    }

    # Bloque para el Frontend (React/SPA)
    location / {
        try_files $uri $uri/ /index.html; 
    }
    
    # Manejo del health check
    location = /health.html {
        return 200 'OK';
        access_log off;
        log_not_found off;
    }

    error_log /var/log/nginx/error.log;
    access_log /var/log/nginx/access.log;
}