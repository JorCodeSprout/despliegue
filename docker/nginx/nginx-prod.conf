server {
    listen 80;
    server_name _;

    # Resolución dinámica para la comunicación interna con Laravel
    # 127.0.0.11 es el DNS interno de Docker/Alpine
    resolver 127.0.0.11 valid=5s; 
    set $internal_backend_host "laravel-api";

    # La raíz apunta al directorio donde se copió el frontend compilado (Paso 3 del Dockerfile)
    root /usr/share/nginx/html; 
    charset utf-8;
    
    # 1. Bloque de manejo de la API (Peticiones que empiezan con /api)
    location /api {
        # CRÍTICO: El fastcgi_pass usa la variable de host para resolución dinámica.
        fastcgi_pass $internal_backend_host:9000;
        
        # SCRIPT_FILENAME apunta a la ruta del index.php copiado (Paso 4 del Dockerfile)
        fastcgi_param SCRIPT_FILENAME /var/www/html/laravel_entrypoint/index.php; 
        
        include fastcgi_params;
        fastcgi_param PATH_INFO $request_uri; 
        fastcgi_param SCRIPT_NAME /index.php;
    }

    # 2. Bloque Principal para el Frontend (SPA / React)
    location / {
        # Lógica de try_files para la SPA:
        # a) Intenta servir el archivo estático solicitado (CSS, JS, imágenes).
        # b) Si no encuentra el archivo estático, devuelve el index.html del frontend.
        #    Esto permite que el router de React/Vite tome el control de las rutas.
        try_files $uri $uri/ /index.html; 
    }
    
    # 3. Manejo explícito de peticiones directas al index.php (Raro, pero seguro)
    location = /index.php {
        # Si alguien accede directamente a /index.php, lo enviamos al backend.
        fastcgi_pass $internal_backend_host:9000;
        fastcgi_param SCRIPT_FILENAME /var/www/html/laravel_entrypoint/index.php; 
        include fastcgi_params;
    }

    # Manejo del health check
    location = /health.html {
        return 200 'OK';
        access_log off;
        log_not_found off;
    }

    error_log /var/log/nginx/error.log;
    access_log /var/log/nginx/access.log;
}